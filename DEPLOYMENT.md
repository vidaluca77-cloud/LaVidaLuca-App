# Guide de Déploiement - La Vida Luca

Ce guide décrit la configuration du déploiement automatique pour l'application La Vida Luca.

## Architecture de Déploiement

- **Frontend**: Next.js déployé sur Vercel
- **Backend**: FastAPI déployé sur Render
- **Base de données**: PostgreSQL sur Render

## 1. Configuration Vercel (Frontend)

### Fichiers de configuration
- `vercel.json` : Configuration principale Vercel
- `next.config.js` : Configuration Next.js optimisée

### Fonctionnalités configurées
- **Sécurité** : Headers de sécurité (CSP, XSS, etc.)
- **Performance** : Mise en cache optimisée
- **Routing** : Redirections et rewrites vers l'API
- **Région** : Déploiement en Europe (fra1)

### Variables d'environnement Vercel
```bash
NEXT_PUBLIC_API_URL=https://lavidaluca-backend.onrender.com
NEXT_PUBLIC_ENVIRONMENT=production
NEXT_TELEMETRY_DISABLED=1
```

### Commandes de déploiement
```bash
# Déploiement manuel
npm run deploy:vercel

# Vérification avant déploiement
npm run deploy:check
```

## 2. Configuration Render (Backend)

### Fichiers de configuration
- `apps/backend/render.yaml` : Configuration du service Render

### Services configurés
- **Web Service** : API FastAPI avec Gunicorn
- **Database** : PostgreSQL 15
- **Auto-deployment** : Déploiement automatique sur push main

### Optimisations Render
- Workers Gunicorn optimisés (4 workers)
- Health check sur `/health`
- Migrations automatiques au démarrage
- Timeout et keep-alive configurés
- Disk storage temporaire

### Variables d'environnement Render
```bash
ENVIRONMENT=production
DATABASE_URL=<auto-generated>
JWT_SECRET_KEY=<auto-generated>
JWT_ALGORITHM=HS256
OPENAI_API_KEY=<manual>
CORS_ORIGINS=["https://lavidaluca.fr","https://www.lavidaluca.fr","https://la-vida-luca.vercel.app"]
LOG_LEVEL=INFO
SENTRY_DSN=<manual>
```

## 3. Scripts de Déploiement Optimisés

### Scripts Frontend
```bash
npm run build:production    # Build de production optimisé
npm run export             # Export statique pour Vercel
npm run analyze            # Analyse du bundle
npm run clean              # Nettoyage du cache
```

### Scripts Backend
```bash
npm run backend:start      # Démarrage production
npm run backend:test:ci    # Tests pour CI/CD
npm run backend:lint       # Linting Python
npm run backend:format     # Formatage du code
```

### Scripts Globaux
```bash
npm run setup:ci           # Installation pour CI
npm run dev:full           # Développement full-stack
npm run deploy:check       # Vérification pré-déploiement
```

## 4. Processus de Déploiement

### Frontend (Vercel)
1. Push sur `main` → Déploiement automatique
2. Preview sur branches → URLs de preview
3. Rollback automatique en cas d'erreur

### Backend (Render)
1. Push sur `main` → Build automatique
2. Migrations automatiques
3. Health check avant mise en service
4. Zero-downtime deployment

## 5. Monitoring et Logs

### Frontend
- Vercel Analytics intégré
- Sentry pour le monitoring d'erreurs
- Métriques Web Vitals

### Backend
- Health check endpoint : `/health`
- Métriques Prometheus : `/metrics`
- Logs structurés avec niveaux
- Monitoring Sentry

## 6. Maintenance

### Mise à jour des dépendances
```bash
# Frontend
npm update
npm audit fix

# Backend
pip install -r requirements.txt --upgrade
```

### Gestion des migrations
```bash
# Créer une migration
npm run backend:migration

# Appliquer les migrations
npm run backend:migrate
```

## 7. Troubleshooting

### Erreurs courantes
1. **Build failed** : Vérifier `npm run type-check`
2. **API unavailable** : Vérifier le health check Render
3. **CORS errors** : Vérifier les CORS_ORIGINS
4. **Database errors** : Vérifier les migrations

### Commandes de diagnostic
```bash
# Vérification complète
npm run deploy:check

# Logs backend
# Voir Render dashboard

# Status des services
curl https://lavidaluca-backend.onrender.com/health
```